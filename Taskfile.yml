version: '3'

# https://taskfile.dev/usage/#env-files
dotenv: [ '.env.local', '.env' ]

vars:
  # https://taskfile.dev/reference/templating/
  BASE_URL: '{{.TASK_BASE_URL | default .COMPOSE_SERVER_DOMAIN | default .COMPOSE_DOMAIN }}'
  DOCKER_COMPOSE: '{{ .TASK_DOCKER_COMPOSE | default "itkdev-docker-compose" }}'
  REPO_URL: 'https://github.com/ai-platform-infrastructure/doc_ingestion_router.git'
  REPO_BRANCH: 'develop'
  VERSION: '0.0.2'
  TARGET_DIR: 'doc_ingestion_router'

tasks:
  default:
    desc: 'List all tasks'
    cmds:
      - task --list-all
    silent: true

  compose:
    desc: "Run `docker compose` command. Example: task compose -- up --detach"
    cmds:
      - '{{ .DOCKER_COMPOSE }} {{ .CLI_ARGS }}'

  ####
  ## Git helpers
  ####
  git:clone:
    desc: "Clone open-webui core"
    cmds:
      - git clone {{ .REPO_URL }}
    silent: true

  open:
    desc: "Open in the browser"
    cmds:
      - open http://{{ .BASE_URL }}/docs
    silent: true

  copy:config:
    desc: "Copy config file from example, if it does not exist"
    cmds:
      - if ! [ -f .env ]; then cp .env.example .env; fi
    silent: true

  tests:
    desc: "Run tests"
    cmds:
      - task compose -- exec api pytest

  ####
  ## Production build
  ####
  prod:build:
    desc: Build docker image and push to docker hub
    cmds:
      - |
        echo "You are about to build and push production images:"
        echo "  - itkdev/doc-ingestion-route:{{.VERSION}}"
        echo "  - itkdev/openwebui:latest"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Build cancelled."
          exit 1
        fi
      - COMPOSE_BAKE=true docker compose --file docker-compose.yml build --build-arg INSTALL_DEV=false --no-cache --pull
      - docker tag docingestion-api itkdev/doc-ingestion-route:{{.VERSION}}
      - docker tag docingestion-api itkdev/doc-ingestion-route:latest
      - docker push itkdev/doc-ingestion-route:{{.VERSION}}
      - docker push itkdev/doc-ingestion-route:latest
    silent: true
